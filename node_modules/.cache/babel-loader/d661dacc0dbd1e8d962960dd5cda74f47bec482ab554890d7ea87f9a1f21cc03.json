{"ast":null,"code":"import React,{useCallback,useEffect,useState}from\"react\";import{fetchLeads}from\"../api/api\";import{useDashboardFilters}from\"../hooks/useDashboardFilters\";import{useToast}from\"../contexts/ToastContext\";import KPICards from\"./KPICards\";import Charts from\"./Charts\";import LeadsTable from\"./LeadsTable\";import LeadModal from\"./LeadModal\";import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const Dashboard=()=>{const[leads,setLeads]=useState([]);const[aggregations,setAggregations]=useState(null);const[limit,setLimit]=useState(10);const[offset,setOffset]=useState(0);const{filters,setFilters}=useDashboardFilters();const[loading,setLoading]=useState(false);const[error,setError]=useState(null);const[selectedLead,setSelectedLead]=useState(null);const{addToast}=useToast();const loadData=useCallback(async()=>{setLoading(true);setError(null);try{const pageLimit=500;let pageOffset=0;let allLeads=[];let resolvedTotal=0;let resolvedAggregations=null;while(true){const data=await fetchLeads({limit:pageLimit,offset:pageOffset});if(!resolvedAggregations&&data.aggregations){resolvedAggregations=data.aggregations;}if(!resolvedTotal){var _data$total;resolvedTotal=(_data$total=data.total)!==null&&_data$total!==void 0?_data$total:0;}const batch=data.leads||[];allLeads=allLeads.concat(batch);if(batch.length<pageLimit||allLeads.length>=resolvedTotal){break;}pageOffset+=pageLimit;}setLeads(allLeads);setAggregations(resolvedAggregations);}catch(err){// eslint-disable-next-line no-console\nconsole.error(err);setError(\"Не удалось загрузить данные. Проверьте REACT_APP_API_URL и доступность Apps Script.\");addToast(\"Не удалось загрузить данные.\",\"error\");}finally{setLoading(false);}},[addToast]);useEffect(()=>{loadData();},[loadData]);const handlePageChange=useCallback(newOffset=>{setOffset(newOffset);},[]);const handlePageSizeChange=useCallback(newLimit=>{setLimit(newLimit);setOffset(0);},[]);const handleFilterChange=useCallback(nextFilters=>{setFilters(nextFilters);setOffset(0);},[setFilters]);const handleViewLead=useCallback(lead=>{setSelectedLead(lead);},[]);const handleCloseModal=useCallback(()=>{setSelectedLead(null);},[]);return/*#__PURE__*/_jsxs(\"div\",{className:\"space-y-4\",children:[error&&/*#__PURE__*/_jsx(\"div\",{className:\"rounded-md border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700\",children:error}),loading&&leads.length===0?/*#__PURE__*/_jsxs(\"div\",{className:\"space-y-4\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"grid gap-4 sm:grid-cols-2 lg:grid-cols-5 mb-6\",children:Array.from({length:5}).map((_,idx)=>/*#__PURE__*/_jsxs(\"div\",{className:\"card p-4\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"h-3 w-24 animate-pulse rounded bg-slate-200 dark:bg-slate-700\"}),/*#__PURE__*/_jsx(\"div\",{className:\"mt-3 h-6 w-20 animate-pulse rounded bg-slate-200 dark:bg-slate-700\"}),/*#__PURE__*/_jsx(\"div\",{className:\"mt-2 h-3 w-32 animate-pulse rounded bg-slate-200 dark:bg-slate-700\"})]},\"kpi-skeleton-\".concat(idx)))}),/*#__PURE__*/_jsx(\"div\",{className:\"card p-4\",children:/*#__PURE__*/_jsx(\"div\",{className:\"space-y-3\",children:Array.from({length:6}).map((_,idx)=>/*#__PURE__*/_jsx(\"div\",{className:\"h-3 w-full animate-pulse rounded bg-slate-200 dark:bg-slate-700\"},\"table-skeleton-\".concat(idx)))})})]}):/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(KPICards,{kpi:aggregations===null||aggregations===void 0?void 0:aggregations.kpi,loading:loading}),/*#__PURE__*/_jsx(Charts,{aggregations:aggregations,loading:loading}),/*#__PURE__*/_jsx(LeadsTable,{leads:leads,limit:limit,offset:offset,onPageChange:handlePageChange,onPageSizeChange:handlePageSizeChange,onFilterChange:handleFilterChange,filters:filters,onViewLead:handleViewLead,loading:loading})]}),selectedLead&&/*#__PURE__*/_jsx(LeadModal,{lead:selectedLead,onClose:handleCloseModal})]});};export default Dashboard;","map":{"version":3,"names":["React","useCallback","useEffect","useState","fetchLeads","useDashboardFilters","useToast","KPICards","Charts","LeadsTable","LeadModal","jsx","_jsx","jsxs","_jsxs","Fragment","_Fragment","Dashboard","leads","setLeads","aggregations","setAggregations","limit","setLimit","offset","setOffset","filters","setFilters","loading","setLoading","error","setError","selectedLead","setSelectedLead","addToast","loadData","pageLimit","pageOffset","allLeads","resolvedTotal","resolvedAggregations","data","_data$total","total","batch","concat","length","err","console","handlePageChange","newOffset","handlePageSizeChange","newLimit","handleFilterChange","nextFilters","handleViewLead","lead","handleCloseModal","className","children","Array","from","map","_","idx","kpi","onPageChange","onPageSizeChange","onFilterChange","onViewLead","onClose"],"sources":["/Users/ikassen/kiakia/frontend/src/components/Dashboard.jsx"],"sourcesContent":["import React, { useCallback, useEffect, useState } from \"react\";\nimport { fetchLeads } from \"../api/api\";\nimport { useDashboardFilters } from \"../hooks/useDashboardFilters\";\nimport { useToast } from \"../contexts/ToastContext\";\nimport KPICards from \"./KPICards\";\nimport Charts from \"./Charts\";\nimport LeadsTable from \"./LeadsTable\";\nimport LeadModal from \"./LeadModal\";\n\nconst Dashboard = () => {\n  const [leads, setLeads] = useState([]);\n  const [aggregations, setAggregations] = useState(null);\n  const [limit, setLimit] = useState(10);\n  const [offset, setOffset] = useState(0);\n  const { filters, setFilters } = useDashboardFilters();\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState(null);\n  const [selectedLead, setSelectedLead] = useState(null);\n  const { addToast } = useToast();\n\n  const loadData = useCallback(async () => {\n    setLoading(true);\n    setError(null);\n    try {\n      const pageLimit = 500;\n      let pageOffset = 0;\n      let allLeads = [];\n      let resolvedTotal = 0;\n      let resolvedAggregations = null;\n\n      while (true) {\n        const data = await fetchLeads({\n          limit: pageLimit,\n          offset: pageOffset\n        });\n\n        if (!resolvedAggregations && data.aggregations) {\n          resolvedAggregations = data.aggregations;\n        }\n\n        if (!resolvedTotal) {\n          resolvedTotal = data.total ?? 0;\n        }\n\n        const batch = data.leads || [];\n        allLeads = allLeads.concat(batch);\n\n        if (batch.length < pageLimit || allLeads.length >= resolvedTotal) {\n          break;\n        }\n\n        pageOffset += pageLimit;\n      }\n\n      setLeads(allLeads);\n      setAggregations(resolvedAggregations);\n    } catch (err) {\n      // eslint-disable-next-line no-console\n      console.error(err);\n      setError(\n        \"Не удалось загрузить данные. Проверьте REACT_APP_API_URL и доступность Apps Script.\"\n      );\n      addToast(\"Не удалось загрузить данные.\", \"error\");\n    } finally {\n      setLoading(false);\n    }\n  }, [addToast]);\n\n  useEffect(() => {\n    loadData();\n  }, [loadData]);\n\n  const handlePageChange = useCallback((newOffset) => {\n    setOffset(newOffset);\n  }, []);\n\n  const handlePageSizeChange = useCallback((newLimit) => {\n    setLimit(newLimit);\n    setOffset(0);\n  }, []);\n\n  const handleFilterChange = useCallback((nextFilters) => {\n    setFilters(nextFilters);\n    setOffset(0);\n  }, [setFilters]);\n\n  const handleViewLead = useCallback((lead) => {\n    setSelectedLead(lead);\n  }, []);\n\n  const handleCloseModal = useCallback(() => {\n    setSelectedLead(null);\n  }, []);\n\n  return (\n    <div className=\"space-y-4\">\n      {error && (\n        <div className=\"rounded-md border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700\">\n          {error}\n        </div>\n      )}\n\n      {loading && leads.length === 0 ? (\n        <div className=\"space-y-4\">\n          <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-5 mb-6\">\n            {Array.from({ length: 5 }).map((_, idx) => (\n              <div key={`kpi-skeleton-${idx}`} className=\"card p-4\">\n                <div className=\"h-3 w-24 animate-pulse rounded bg-slate-200 dark:bg-slate-700\" />\n                <div className=\"mt-3 h-6 w-20 animate-pulse rounded bg-slate-200 dark:bg-slate-700\" />\n                <div className=\"mt-2 h-3 w-32 animate-pulse rounded bg-slate-200 dark:bg-slate-700\" />\n              </div>\n            ))}\n          </div>\n          <div className=\"card p-4\">\n            <div className=\"space-y-3\">\n              {Array.from({ length: 6 }).map((_, idx) => (\n                <div key={`table-skeleton-${idx}`} className=\"h-3 w-full animate-pulse rounded bg-slate-200 dark:bg-slate-700\" />\n              ))}\n            </div>\n          </div>\n        </div>\n      ) : (\n        <>\n          <KPICards kpi={aggregations?.kpi} loading={loading} />\n          <Charts aggregations={aggregations} loading={loading} />\n          <LeadsTable\n            leads={leads}\n            limit={limit}\n            offset={offset}\n            onPageChange={handlePageChange}\n            onPageSizeChange={handlePageSizeChange}\n            onFilterChange={handleFilterChange}\n            filters={filters}\n            onViewLead={handleViewLead}\n            loading={loading}\n          />\n        </>\n      )}\n\n      {selectedLead && (\n        <LeadModal lead={selectedLead} onClose={handleCloseModal} />\n      )}\n    </div>\n  );\n};\n\nexport default Dashboard;\n\n"],"mappings":"AAAA,MAAO,CAAAA,KAAK,EAAIC,WAAW,CAAEC,SAAS,CAAEC,QAAQ,KAAQ,OAAO,CAC/D,OAASC,UAAU,KAAQ,YAAY,CACvC,OAASC,mBAAmB,KAAQ,8BAA8B,CAClE,OAASC,QAAQ,KAAQ,0BAA0B,CACnD,MAAO,CAAAC,QAAQ,KAAM,YAAY,CACjC,MAAO,CAAAC,MAAM,KAAM,UAAU,CAC7B,MAAO,CAAAC,UAAU,KAAM,cAAc,CACrC,MAAO,CAAAC,SAAS,KAAM,aAAa,CAAC,OAAAC,GAAA,IAAAC,IAAA,CAAAC,IAAA,IAAAC,KAAA,CAAAC,QAAA,IAAAC,SAAA,yBAEpC,KAAM,CAAAC,SAAS,CAAGA,CAAA,GAAM,CACtB,KAAM,CAACC,KAAK,CAAEC,QAAQ,CAAC,CAAGhB,QAAQ,CAAC,EAAE,CAAC,CACtC,KAAM,CAACiB,YAAY,CAAEC,eAAe,CAAC,CAAGlB,QAAQ,CAAC,IAAI,CAAC,CACtD,KAAM,CAACmB,KAAK,CAAEC,QAAQ,CAAC,CAAGpB,QAAQ,CAAC,EAAE,CAAC,CACtC,KAAM,CAACqB,MAAM,CAAEC,SAAS,CAAC,CAAGtB,QAAQ,CAAC,CAAC,CAAC,CACvC,KAAM,CAAEuB,OAAO,CAAEC,UAAW,CAAC,CAAGtB,mBAAmB,CAAC,CAAC,CACrD,KAAM,CAACuB,OAAO,CAAEC,UAAU,CAAC,CAAG1B,QAAQ,CAAC,KAAK,CAAC,CAC7C,KAAM,CAAC2B,KAAK,CAAEC,QAAQ,CAAC,CAAG5B,QAAQ,CAAC,IAAI,CAAC,CACxC,KAAM,CAAC6B,YAAY,CAAEC,eAAe,CAAC,CAAG9B,QAAQ,CAAC,IAAI,CAAC,CACtD,KAAM,CAAE+B,QAAS,CAAC,CAAG5B,QAAQ,CAAC,CAAC,CAE/B,KAAM,CAAA6B,QAAQ,CAAGlC,WAAW,CAAC,SAAY,CACvC4B,UAAU,CAAC,IAAI,CAAC,CAChBE,QAAQ,CAAC,IAAI,CAAC,CACd,GAAI,CACF,KAAM,CAAAK,SAAS,CAAG,GAAG,CACrB,GAAI,CAAAC,UAAU,CAAG,CAAC,CAClB,GAAI,CAAAC,QAAQ,CAAG,EAAE,CACjB,GAAI,CAAAC,aAAa,CAAG,CAAC,CACrB,GAAI,CAAAC,oBAAoB,CAAG,IAAI,CAE/B,MAAO,IAAI,CAAE,CACX,KAAM,CAAAC,IAAI,CAAG,KAAM,CAAArC,UAAU,CAAC,CAC5BkB,KAAK,CAAEc,SAAS,CAChBZ,MAAM,CAAEa,UACV,CAAC,CAAC,CAEF,GAAI,CAACG,oBAAoB,EAAIC,IAAI,CAACrB,YAAY,CAAE,CAC9CoB,oBAAoB,CAAGC,IAAI,CAACrB,YAAY,CAC1C,CAEA,GAAI,CAACmB,aAAa,CAAE,KAAAG,WAAA,CAClBH,aAAa,EAAAG,WAAA,CAAGD,IAAI,CAACE,KAAK,UAAAD,WAAA,UAAAA,WAAA,CAAI,CAAC,CACjC,CAEA,KAAM,CAAAE,KAAK,CAAGH,IAAI,CAACvB,KAAK,EAAI,EAAE,CAC9BoB,QAAQ,CAAGA,QAAQ,CAACO,MAAM,CAACD,KAAK,CAAC,CAEjC,GAAIA,KAAK,CAACE,MAAM,CAAGV,SAAS,EAAIE,QAAQ,CAACQ,MAAM,EAAIP,aAAa,CAAE,CAChE,MACF,CAEAF,UAAU,EAAID,SAAS,CACzB,CAEAjB,QAAQ,CAACmB,QAAQ,CAAC,CAClBjB,eAAe,CAACmB,oBAAoB,CAAC,CACvC,CAAE,MAAOO,GAAG,CAAE,CACZ;AACAC,OAAO,CAAClB,KAAK,CAACiB,GAAG,CAAC,CAClBhB,QAAQ,CACN,qFACF,CAAC,CACDG,QAAQ,CAAC,8BAA8B,CAAE,OAAO,CAAC,CACnD,CAAC,OAAS,CACRL,UAAU,CAAC,KAAK,CAAC,CACnB,CACF,CAAC,CAAE,CAACK,QAAQ,CAAC,CAAC,CAEdhC,SAAS,CAAC,IAAM,CACdiC,QAAQ,CAAC,CAAC,CACZ,CAAC,CAAE,CAACA,QAAQ,CAAC,CAAC,CAEd,KAAM,CAAAc,gBAAgB,CAAGhD,WAAW,CAAEiD,SAAS,EAAK,CAClDzB,SAAS,CAACyB,SAAS,CAAC,CACtB,CAAC,CAAE,EAAE,CAAC,CAEN,KAAM,CAAAC,oBAAoB,CAAGlD,WAAW,CAAEmD,QAAQ,EAAK,CACrD7B,QAAQ,CAAC6B,QAAQ,CAAC,CAClB3B,SAAS,CAAC,CAAC,CAAC,CACd,CAAC,CAAE,EAAE,CAAC,CAEN,KAAM,CAAA4B,kBAAkB,CAAGpD,WAAW,CAAEqD,WAAW,EAAK,CACtD3B,UAAU,CAAC2B,WAAW,CAAC,CACvB7B,SAAS,CAAC,CAAC,CAAC,CACd,CAAC,CAAE,CAACE,UAAU,CAAC,CAAC,CAEhB,KAAM,CAAA4B,cAAc,CAAGtD,WAAW,CAAEuD,IAAI,EAAK,CAC3CvB,eAAe,CAACuB,IAAI,CAAC,CACvB,CAAC,CAAE,EAAE,CAAC,CAEN,KAAM,CAAAC,gBAAgB,CAAGxD,WAAW,CAAC,IAAM,CACzCgC,eAAe,CAAC,IAAI,CAAC,CACvB,CAAC,CAAE,EAAE,CAAC,CAEN,mBACEnB,KAAA,QAAK4C,SAAS,CAAC,WAAW,CAAAC,QAAA,EACvB7B,KAAK,eACJlB,IAAA,QAAK8C,SAAS,CAAC,8EAA8E,CAAAC,QAAA,CAC1F7B,KAAK,CACH,CACN,CAEAF,OAAO,EAAIV,KAAK,CAAC4B,MAAM,GAAK,CAAC,cAC5BhC,KAAA,QAAK4C,SAAS,CAAC,WAAW,CAAAC,QAAA,eACxB/C,IAAA,QAAK8C,SAAS,CAAC,+CAA+C,CAAAC,QAAA,CAC3DC,KAAK,CAACC,IAAI,CAAC,CAAEf,MAAM,CAAE,CAAE,CAAC,CAAC,CAACgB,GAAG,CAAC,CAACC,CAAC,CAAEC,GAAG,gBACpClD,KAAA,QAAiC4C,SAAS,CAAC,UAAU,CAAAC,QAAA,eACnD/C,IAAA,QAAK8C,SAAS,CAAC,+DAA+D,CAAE,CAAC,cACjF9C,IAAA,QAAK8C,SAAS,CAAC,oEAAoE,CAAE,CAAC,cACtF9C,IAAA,QAAK8C,SAAS,CAAC,oEAAoE,CAAE,CAAC,mBAAAb,MAAA,CAH9DmB,GAAG,CAIxB,CACN,CAAC,CACC,CAAC,cACNpD,IAAA,QAAK8C,SAAS,CAAC,UAAU,CAAAC,QAAA,cACvB/C,IAAA,QAAK8C,SAAS,CAAC,WAAW,CAAAC,QAAA,CACvBC,KAAK,CAACC,IAAI,CAAC,CAAEf,MAAM,CAAE,CAAE,CAAC,CAAC,CAACgB,GAAG,CAAC,CAACC,CAAC,CAAEC,GAAG,gBACpCpD,IAAA,QAAmC8C,SAAS,CAAC,iEAAiE,oBAAAb,MAAA,CAAlFmB,GAAG,CAAiF,CACjH,CAAC,CACC,CAAC,CACH,CAAC,EACH,CAAC,cAENlD,KAAA,CAAAE,SAAA,EAAA2C,QAAA,eACE/C,IAAA,CAACL,QAAQ,EAAC0D,GAAG,CAAE7C,YAAY,SAAZA,YAAY,iBAAZA,YAAY,CAAE6C,GAAI,CAACrC,OAAO,CAAEA,OAAQ,CAAE,CAAC,cACtDhB,IAAA,CAACJ,MAAM,EAACY,YAAY,CAAEA,YAAa,CAACQ,OAAO,CAAEA,OAAQ,CAAE,CAAC,cACxDhB,IAAA,CAACH,UAAU,EACTS,KAAK,CAAEA,KAAM,CACbI,KAAK,CAAEA,KAAM,CACbE,MAAM,CAAEA,MAAO,CACf0C,YAAY,CAAEjB,gBAAiB,CAC/BkB,gBAAgB,CAAEhB,oBAAqB,CACvCiB,cAAc,CAAEf,kBAAmB,CACnC3B,OAAO,CAAEA,OAAQ,CACjB2C,UAAU,CAAEd,cAAe,CAC3B3B,OAAO,CAAEA,OAAQ,CAClB,CAAC,EACF,CACH,CAEAI,YAAY,eACXpB,IAAA,CAACF,SAAS,EAAC8C,IAAI,CAAExB,YAAa,CAACsC,OAAO,CAAEb,gBAAiB,CAAE,CAC5D,EACE,CAAC,CAEV,CAAC,CAED,cAAe,CAAAxC,SAAS","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}